name: üîç Diagn√≥stico Google Sheets

on:
  workflow_dispatch:
    inputs:
      accion:
        description: 'Acci√≥n a realizar'
        required: true
        default: 'diagnosticar'
        type: choice
        options:
          - diagnosticar
          - test_conexion
          - verificar_permisos

jobs:
  diagnostico:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Ejecutar Diagn√≥stico
      env:
        GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        GOOGLE_SHEET_ID_MOTICK: ${{ secrets.GOOGLE_SHEET_ID_MOTICK }}
      run: |
        cd src
        python -c "
        import os
        import json
        from google_sheets_motick import GoogleSheetsMotick

        print('='*80)
        print('DIAGN√ìSTICO COMPLETO - GOOGLE SHEETS MOTICK')
        print('='*80)

        # Verificar variables de entorno
        credentials_json = os.getenv('GOOGLE_CREDENTIALS_JSON')
        sheet_id = os.getenv('GOOGLE_SHEET_ID_MOTICK')

        print(f'üîç VERIFICANDO CONFIGURACI√ìN:')
        print(f'   GOOGLE_CREDENTIALS_JSON: {\"‚úÖ Configurado\" if credentials_json else \"‚ùå Faltante\"}')
        print(f'   GOOGLE_SHEET_ID_MOTICK: {sheet_id if sheet_id else \"‚ùå Faltante\"}')

        if not credentials_json:
            print('‚ùå ERROR CR√çTICO: GOOGLE_CREDENTIALS_JSON no encontrado en secrets')
            exit(1)
        
        if not sheet_id:
            print('‚ùå ERROR CR√çTICO: GOOGLE_SHEET_ID_MOTICK no encontrado en secrets')
            exit(1)

        # Verificar service account email
        try:
            cred_dict = json.loads(credentials_json)
            service_email = cred_dict.get('client_email', 'NO_ENCONTRADO')
            project_id = cred_dict.get('project_id', 'NO_ENCONTRADO')
            
            print(f'ü§ñ SERVICE ACCOUNT:')
            print(f'   Email: {service_email}')
            print(f'   Proyecto: {project_id}')
            
        except Exception as e:
            print(f'‚ùå ERROR: Credenciales JSON inv√°lidas: {str(e)}')
            exit(1)

        # Crear handler y probar conexi√≥n
        try:
            gs_handler = GoogleSheetsMotick(
                credentials_json_string=credentials_json,
                sheet_id=sheet_id
            )
            
            # Ejecutar test completo
            exito = gs_handler.test_connection()
            
            if exito:
                print(f'\\nüéâ DIAGN√ìSTICO: ‚úÖ SIN PROBLEMAS')
                print(f'El sistema deber√≠a funcionar correctamente')
            else:
                print(f'\\n‚ö†Ô∏è  DIAGN√ìSTICO: ‚ùå PROBLEMAS ENCONTRADOS')
                print(f'Sigue las instrucciones de soluci√≥n mostradas arriba')
                exit(1)
                
        except Exception as e:
            print(f'‚ùå ERROR CR√çTICO EN DIAGN√ìSTICO: {str(e)}')
            import traceback
            traceback.print_exc()
            exit(1)
        "
        
    - name: Mostrar Soluciones
      if: failure()
      run: |
        echo ""
        echo "üö® SOLUCIONES PARA PROBLEMAS COMUNES:"
        echo ""
        echo "1Ô∏è‚É£ PROBLEMA: Google Sheet no compartido"
        echo "   SOLUCI√ìN:"
        echo "   ‚Ä¢ Abre: https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID_MOTICK }}"
        echo "   ‚Ä¢ Clic en 'Compartir' (bot√≥n azul)"
        echo "   ‚Ä¢ Agregar email: motick-scraper-bot@motick-data-scraper.iam.gserviceaccount.com"
        echo "   ‚Ä¢ Permisos: Editor"
        echo "   ‚Ä¢ Clic en 'Enviar'"
        echo ""
        echo "2Ô∏è‚É£ PROBLEMA: APIs no habilitadas"
        echo "   SOLUCI√ìN:"
        echo "   ‚Ä¢ Ve a: https://console.cloud.google.com/apis/dashboard?project=motick-data-scraper"
        echo "   ‚Ä¢ Habilitar: Google Sheets API"
        echo "   ‚Ä¢ Habilitar: Google Drive API"
        echo ""
        echo "3Ô∏è‚É£ PROBLEMA: Sheet no es nativo de Google"
        echo "   SOLUCI√ìN:"
        echo "   ‚Ä¢ Abre el sheet en Google Drive"
        echo "   ‚Ä¢ Clic derecho ‚Üí Abrir con ‚Üí Google Sheets"
        echo "   ‚Ä¢ Archivo ‚Üí Guardar como Google Sheets"
        echo "   ‚Ä¢ Actualizar GOOGLE_SHEET_ID_MOTICK con el nuevo ID"
